<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>Рассказы — Даша Художник</title>
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      padding: max(1.5rem, env(safe-area-inset-top)) max(1.5rem, env(safe-area-inset-right)) max(3rem, env(safe-area-inset-bottom)) max(1.5rem, env(safe-area-inset-left));
      font-family: Georgia, "Times New Roman", serif;
      font-size: clamp(1.05rem, 2.2vw, 1.25rem);
      line-height: 1.7;
      color: #2c2825;
      background: #e8e0d6;
      min-height: 100vh;
      min-height: 100dvh;
    }
    .stories-nav { display: flex; flex-wrap: wrap; gap: clamp(1rem, 4vw, 1.5rem); justify-content: center; margin: 2.5rem 0 2rem; padding: 0 1rem; }
    .stories-nav__btn {
      display: inline-flex; align-items: center; justify-content: center;
      padding: clamp(0.65rem, 2vw, 0.85rem) clamp(1.25rem, 4vw, 1.75rem);
      min-height: 48px; min-width: 44px;
      border-radius: 8px; border: 1px solid rgba(0,0,0,0.12);
      background: #d4cfc4; color: #2c2825;
      font-family: Georgia, "Times New Roman", serif;
      font-size: clamp(0.9rem, 1.8vw, 1.05rem); font-weight: 600;
      letter-spacing: 0.04em; text-decoration: none;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
      transition: background 0.2s ease, transform 0.2s ease, box-shadow 0.2s ease;
      -webkit-tap-highlight-color: transparent;
    }
    .stories-nav__btn:hover { background: #c9c4b8; transform: translateY(-1px); box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    a.back {
      display: inline-flex; align-items: center; justify-content: center;
      padding: clamp(0.5rem, 1.2vw, 0.65rem) clamp(1rem, 2vw, 1.25rem);
      min-height: 48px; min-width: 44px; margin-bottom: 1.5rem;
      border-radius: 8px; border: 1px solid rgba(0,0,0,0.12);
      background: #d4cfc4; color: #2c2825;
      font-family: system-ui, sans-serif; font-size: clamp(0.9rem, 1.2vw, 1rem);
      font-weight: 500; text-decoration: none;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
      transition: background 0.2s ease, transform 0.2s ease;
      -webkit-tap-highlight-color: transparent;
    }
    a.back:hover { background: #c9c4b8; transform: translateY(-1px); }
    article { max-width: 720px; margin: 0 auto 3rem; }
    article:last-child { margin-bottom: 2rem; }
    .story-cover { width: 100%; max-height: 60vh; object-fit: cover; border-radius: 12px; margin-bottom: 1.5rem; display: block; }
    .story-title { font-size: clamp(1.5rem, 4vw, 2.2rem); margin: 0 0 0.75em; font-weight: 600; color: #0d0d18; }
    .story-content { white-space: pre-wrap; word-wrap: break-word; }
    .story-content a.story-link { color: #2563eb; text-decoration: underline; }
    .story-content a.story-link:hover { color: #1d4ed8; }
    .loading { text-align: center; padding: 3rem; color: #6b6b8a; }
    .error { color: #c44; padding: 1rem; }
  </style>
</head>
<body>
  <div id="globe-container" class="globe-fixed"></div>
  <a class="back" href="index.html" id="stories-back-top" data-i18n="stories_back">← На главную</a>
  <div id="root">
    <p class="loading" data-i18n="stories_loading">Загрузка рассказов…</p>
  </div>
  <nav class="stories-nav" aria-label="Навигация">
    <a class="stories-nav__btn" href="index.html#gallery" id="stories-btn-main" data-i18n="stories_nav_main">На главную</a>
    <a class="stories-nav__btn" href="index.html" id="stories-btn-start" data-i18n="stories_nav_start">На стартовую</a>
  </nav>
  <div id="atmosphere-widget" class="atmosphere-widget" aria-label="Настройки атмосферы"></div>
  <script src="atmosphere.js" defer></script>
  <script src="i18n.js" defer></script>
  <script>
(function () {
  document.addEventListener("DOMContentLoaded", function() {
    if (window.I18n) window.I18n.init(document.getElementById("globe-container"));
  });
  const root = document.getElementById("root");
  const url = "https://raw.githubusercontent.com/dasha-home/Soul-Art/main/data/stories.json";
  fetch(url + "?t=" + Date.now(), { cache: "no-store" })
    .then(r => r.ok ? r.text() : Promise.reject(new Error("Не удалось загрузить")))
    .then(text => {
      const data = JSON.parse(text);
      const stories = Array.isArray(data.stories) ? data.stories : [];
      if (stories.length === 0) {
        root.innerHTML = "<p class=\"loading\" data-i18n=\"stories_no\">" + (window.I18n ? window.I18n.t("stories_no") : "Пока нет рассказов.") + "</p>";
        if (window.I18n) window.I18n.applyToPage();
        return;
      }
      root.innerHTML = stories.map(s => {
        const cover = s.coverUrl ? "<img class=\"story-cover\" src=\"" + escapeAttr(s.coverUrl) + "\" alt=\"\" loading=\"lazy\" />" : "";
        return "<article>" + cover + "<h1 class=\"story-title\">" + escapeHtml(s.title || "") + "</h1><div class=\"story-content\">" + linkify(s.content || "") + "</div></article>";
      }).join("");
    })
        .catch(() => {
      fetch("./data/stories.json", { cache: "no-store" })
        .then(r => r.ok ? r.text() : Promise.reject())
        .then(text => {
          const data = JSON.parse(text);
          const stories = Array.isArray(data.stories) ? data.stories : [];
          if (stories.length === 0) { root.innerHTML = "<p class=\"loading\" data-i18n=\"stories_no\">" + (window.I18n ? window.I18n.t("stories_no") : "Пока нет рассказов.") + "</p>"; if (window.I18n) window.I18n.applyToPage(); return; }
          root.innerHTML = stories.map(s => {
            const cover = s.coverUrl ? "<img class=\"story-cover\" src=\"" + escapeAttr(s.coverUrl) + "\" alt=\"\" loading=\"lazy\" />" : "";
            return "<article>" + cover + "<h1 class=\"story-title\">" + escapeHtml(s.title || "") + "</h1><div class=\"story-content\">" + linkify(s.content || "") + "</div></article>";
          }).join("");
        })
        .catch(() => { root.innerHTML = "<p class=\"error\" data-i18n=\"stories_error\">" + (window.I18n ? window.I18n.t("stories_error") : "Не удалось загрузить рассказы.") + "</p>"; if (window.I18n) window.I18n.applyToPage(); });
    });

  function escapeHtml(s) {
    const d = document.createElement("div");
    d.textContent = s;
    return d.innerHTML;
  }
  function escapeAttr(s) {
    return s.replace(/&/g, "&amp;").replace(/"/g, "&quot;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
  }
  function linkify(text) {
    var re = /(https?:\/\/[^\s<>"')\]]+)/g;
    var parts = text.split(re);
    var out = [];
    for (var i = 0; i < parts.length; i++) {
      if (i % 2 === 1) {
        out.push("<a class=\"story-link\" href=\"" + escapeAttr(parts[i]) + "\" target=\"_blank\" rel=\"noopener noreferrer\">" + escapeHtml(parts[i]) + "</a>");
      } else {
        out.push(escapeHtml(parts[i]));
      }
    }
    return out.join("");
  }
  function playPapyrusClick(variant) {
    try {
      var C = window.AudioContext || window.webkitAudioContext;
      if (!C) return;
      var ctx = new C();
      var duration = 0.055;
      var buf = ctx.createBuffer(1, ctx.sampleRate * duration, ctx.sampleRate);
      var ch = buf.getChannelData(0);
      var decay = 0.012 + variant * 0.003;
      var freq = 600 + variant * 120;
      for (var i = 0; i < buf.length; i++) ch[i] = (Math.random() * 2 - 1) * Math.exp(-i / (ctx.sampleRate * decay));
      var src = ctx.createBufferSource();
      src.buffer = buf;
      var filter = ctx.createBiquadFilter();
      filter.type = "highpass";
      filter.frequency.value = freq;
      var gain = ctx.createGain();
      gain.gain.setValueAtTime(0.12, ctx.currentTime);
      gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.045);
      src.connect(filter); filter.connect(gain); gain.connect(ctx.destination);
      src.start(0); src.stop(duration);
    } catch (_) {}
  }
  var btnMain = document.getElementById("stories-btn-main");
  var btnStart = document.getElementById("stories-btn-start");
  var backTop = document.getElementById("stories-back-top");
  if (btnMain) btnMain.addEventListener("click", function(e) { e.preventDefault(); playPapyrusClick(4); setTimeout(function() { window.location.href = btnMain.getAttribute("href"); }, 120); });
  if (btnStart) btnStart.addEventListener("click", function(e) { e.preventDefault(); playPapyrusClick(5); setTimeout(function() { window.location.href = btnStart.getAttribute("href"); }, 120); });
  if (backTop) backTop.addEventListener("click", function(e) { e.preventDefault(); playPapyrusClick(4); setTimeout(function() { window.location.href = backTop.getAttribute("href"); }, 120); });
})();
  </script>
</body>
</html>
