<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Админка Даши — загрузка фото</title>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #0a0614;
      color: #e8e0f0;
      min-height: 100vh;
      padding: 2rem 1rem 4rem;
    }

    h1 {
      font-size: 1.5rem;
      font-weight: 500;
      margin-bottom: 0.3rem;
      color: #fff;
    }

    .eyebrow {
      font-size: 0.72rem;
      letter-spacing: 0.22em;
      text-transform: uppercase;
      color: #8870aa;
      margin-bottom: 0.4rem;
    }

    .page { max-width: 960px; margin: 0 auto; }

    /* Карточка формы */
    .card {
      background: linear-gradient(160deg, rgba(30,18,56,0.95), rgba(12,8,28,0.98));
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 20px;
      padding: 2rem;
      margin-bottom: 2rem;
    }

    .card p { font-size: 0.9rem; color: #9980bb; margin: 0.5rem 0 1.25rem; line-height: 1.55; }

    label { display: flex; flex-direction: column; gap: 0.3rem; margin-bottom: 1rem; font-size: 0.85rem; color: #c0aada; }
    label span { color: #e8e0f0; }

    input[type="text"], input[type="file"], input[type="password"] {
      padding: 0.6rem 0.9rem;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,0.15);
      background: rgba(255,255,255,0.06);
      color: #e8e0f0;
      font: inherit;
      font-size: 0.95rem;
      width: 100%;
    }
    input:focus { outline: none; border-color: #b07ade; background: rgba(176,122,222,0.08); }

    .btn {
      display: inline-block;
      padding: 0.65rem 1.4rem;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.18);
      background: rgba(255,255,255,0.07);
      color: #e8e0f0;
      font: inherit;
      font-size: 0.9rem;
      cursor: pointer;
      transition: background 0.2s, border-color 0.2s;
      margin-top: 0.5rem;
    }
    .btn:hover { background: rgba(255,255,255,0.12); }
    .btn--primary { background: rgba(176,122,222,0.2); border-color: rgba(176,122,222,0.5); color: #d4aaff; }
    .btn--primary:hover { background: rgba(176,122,222,0.32); }
    .btn:disabled { opacity: 0.55; cursor: not-allowed; }

    .msg { margin-top: 1rem; font-size: 0.88rem; min-height: 1.4em; }
    .msg--ok  { color: #7dd3a0; }
    .msg--err { color: #e07c7c; }

    /* Галерея */
    .gallery-title {
      font-size: 1.1rem;
      font-weight: 500;
      color: #fff;
      margin-bottom: 1.25rem;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
      gap: 0.8rem;
    }

    .photo-card {
      position: relative;
      border-radius: 12px;
      overflow: hidden;
      background: rgba(255,255,255,0.04);
      border: 1px solid rgba(255,255,255,0.09);
      transition: border-color 0.2s, transform 0.2s;
    }
    .photo-card:hover { border-color: rgba(255,255,255,0.2); transform: translateY(-2px); }

    .photo-card img {
      width: 100%;
      aspect-ratio: 1/1;
      object-fit: cover;
      display: block;
      transition: transform 0.3s;
    }
    .photo-card:hover img { transform: scale(1.06); }

    .photo-info { padding: 0.4rem 0.55rem 0.5rem; }
    .photo-name { font-size: 0.75rem; color: #e8e0f0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .photo-sub  { font-size: 0.66rem; color: #8870aa; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

    .del-btn {
      position: absolute;
      top: 5px; right: 5px;
      width: 24px; height: 24px;
      border-radius: 50%;
      border: none;
      background: rgba(210,50,50,0.8);
      color: #fff;
      font-size: 0.68rem;
      cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      opacity: 0;
      transition: opacity 0.2s;
    }
    .photo-card:hover .del-btn { opacity: 1; }
    .del-btn:hover { background: rgba(220,40,40,1); }
    .del-btn:disabled { cursor: not-allowed; opacity: 0.6; }

    .hint { color: #7a6890; font-size: 0.8rem; padding: 0.5rem 0; }
  </style>
</head>
<body>
<div class="page">

  <!-- ФОРМА ЗАГРУЗКИ -->
  <div class="card">
    <div class="eyebrow">для Даши</div>
    <h1>Загрузить картину на сайт</h1>
    <p>Выбери файл, напиши название — и картина появится в галерее.</p>

    <form id="upload-form">
      <label><span>Файл (фото)</span>
        <input type="file" id="file-input" accept="image/*" required />
      </label>
      <label><span>Название работы</span>
        <input type="text" id="title-input" placeholder="Например: Закат над морем" required />
      </label>
      <label><span>Подпись (необязательно)</span>
        <input type="text" id="subtitle-input" placeholder="Серия, год, техника" />
      </label>
      <button type="submit" class="btn btn--primary" id="upload-btn">Загрузить на сайт</button>
    </form>
    <p id="msg" class="msg" aria-live="polite"></p>
  </div>

  <!-- ГАЛЕРЕЯ -->
  <div class="card">
    <div class="gallery-title">Мои работы в галерее</div>
    <div id="grid" class="grid"><p class="hint">Загружаю список…</p></div>
  </div>

</div>

<script>
// ═══════════════════════════════════════════════════════
//  ТОКЕН — вставь сюда и отдай файл Даше
// ═══════════════════════════════════════════════════════
var TOKEN = "ВСТАВЬ_ТОКЕН_СЮДА";
// ═══════════════════════════════════════════════════════

var REPO  = { owner: "dasha-home", repo: "Soul-Art" };
var CDNBASE = "https://raw.githubusercontent.com/" + REPO.owner + "/" + REPO.repo + "/main/";

/* ── GitHub API ── */
async function ghApi(path, opts) {
  var url = "https://api.github.com/repos/" + REPO.owner + "/" + REPO.repo + "/contents/" + path;
  var res = await fetch(url, {
    ...opts,
    headers: { Accept: "application/vnd.github.v3+json", Authorization: "token " + TOKEN, ...(opts.headers || {}) }
  });
  if (!res.ok) { var e = await res.json().catch(() => ({})); throw new Error(e.message || res.statusText); }
  return res.json();
}

function toBase64(file) {
  return new Promise((ok, fail) => {
    var r = new FileReader();
    r.onload = () => ok(r.result.replace(/^data:[^;]+;base64,/, ""));
    r.onerror = fail;
    r.readAsDataURL(file);
  });
}

function safeName(name) {
  var base = name.replace(/\.[^.]+$/, "").replace(/[^a-zA-Z0-9_-]/g, "_").slice(0, 40) || "image";
  var ext  = (name.match(/\.[^.]+$/) || [".png"])[0].toLowerCase();
  return base + ext;
}

/* ── Загрузка ── */
var form      = document.getElementById("upload-form");
var fileInput = document.getElementById("file-input");
var titleInput= document.getElementById("title-input");
var subInput  = document.getElementById("subtitle-input");
var uploadBtn = document.getElementById("upload-btn");
var msgEl     = document.getElementById("msg");

form.addEventListener("submit", async (e) => {
  e.preventDefault();
  var file = fileInput.files[0];
  if (!file) { msgEl.textContent = "Выбери файл."; return; }
  var title    = titleInput.value.trim() || file.name;
  var subtitle = subInput.value.trim();

  uploadBtn.disabled = true;
  msgEl.className = "msg";
  msgEl.textContent = "Загружаю…";

  try {
    var b64      = await toBase64(file);
    var filename = safeName(file.name);
    var imgPath  = "data/images/" + filename;

    await ghApi(imgPath, { method: "PUT", body: JSON.stringify({
      message: "Добавить фото: " + filename, content: b64
    }) });

    var jsonRes  = await ghApi("data/artworks.json", { method: "GET" });
    var data     = JSON.parse(atob(jsonRes.content.replace(/\n/g, "")));
    var id       = filename.replace(/\.[^.]+$/, "").replace(/[^a-z0-9]/gi, "-").toLowerCase();
    data.artworks = data.artworks || [];
    data.artworks.push({ id, title, subtitle, imageUrl: "./" + imgPath });
    var newJson  = btoa(unescape(encodeURIComponent(JSON.stringify(data, null, 2))));
    await ghApi("data/artworks.json", { method: "PUT", body: JSON.stringify({
      message: "Добавить работу: " + title, content: newJson, sha: jsonRes.sha
    }) });

    msgEl.textContent = "Готово! «" + title + "» появится в галерее через минуту.";
    msgEl.className = "msg msg--ok";
    form.reset();
    loadGallery();
  } catch (err) {
    msgEl.textContent = "Ошибка: " + (err.message || "не удалось загрузить");
    msgEl.className = "msg msg--err";
  }
  uploadBtn.disabled = false;
});

/* ── Галерея ── */
var grid = document.getElementById("grid");

async function loadGallery() {
  grid.innerHTML = "<p class='hint'>Загружаю…</p>";
  try {
    var res   = await ghApi("data/artworks.json", { method: "GET" });
    var data  = JSON.parse(atob(res.content.replace(/\n/g, "")));
    var list  = (data.artworks || []).slice().reverse();
    if (!list.length) { grid.innerHTML = "<p class='hint'>Работ пока нет. Загрузи первую!</p>"; return; }
    grid.innerHTML = "";
    list.forEach(art => {
      var raw = art.imageUrl || "";
      var src = raw.startsWith("./data/images/")
        ? CDNBASE + "data/images/" + raw.replace("./data/images/", "")
        : raw;

      var card = document.createElement("div");
      card.className = "photo-card";
      card.innerHTML = `
        <img src="${src}" alt="${art.title || ""}" loading="lazy" />
        <div class="photo-info">
          <div class="photo-name" title="${art.title || ""}">${art.title || "—"}</div>
          ${art.subtitle ? `<div class="photo-sub">${art.subtitle}</div>` : ""}
        </div>
        <button class="del-btn" title="Удалить">✕</button>
      `;

      card.querySelector(".del-btn").addEventListener("click", async () => {
        if (!confirm("Удалить «" + (art.title || art.id) + "» из галереи?")) return;
        var btn = card.querySelector(".del-btn");
        btn.disabled = true; btn.textContent = "…";
        try {
          var jr = await ghApi("data/artworks.json", { method: "GET" });
          var jd = JSON.parse(atob(jr.content.replace(/\n/g, "")));
          jd.artworks = (jd.artworks || []).filter(a => a.id !== art.id);
          var nj = btoa(unescape(encodeURIComponent(JSON.stringify(jd, null, 2))));
          await ghApi("data/artworks.json", { method: "PUT", body: JSON.stringify({
            message: "Удалить работу: " + art.id, content: nj, sha: jr.sha
          }) });
          try {
            var fn  = raw.replace("./data/images/", "");
            var ir  = await ghApi("data/images/" + fn, { method: "GET" });
            await ghApi("data/images/" + fn, { method: "DELETE", body: JSON.stringify({
              message: "Удалить изображение: " + fn, sha: ir.sha
            }) });
          } catch (_) {}
          card.remove();
          if (!grid.querySelector(".photo-card")) grid.innerHTML = "<p class='hint'>Работ нет.</p>";
        } catch (err) {
          btn.disabled = false; btn.textContent = "✕";
          alert("Ошибка удаления: " + (err.message || ""));
        }
      });

      grid.appendChild(card);
    });
  } catch (err) {
    grid.innerHTML = "<p class='hint'>Не удалось загрузить список: " + (err.message || "") + "</p>";
  }
}

loadGallery();
</script>
</body>
</html>
